<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Graph Visualization with Cytoscape.js</title>
    <script src="cytoscape.min.js"></script>
    <style>
        #cy {
            width: 100%;
            height: 600px;
            display: block;
        }
    </style>
</head>
<body>
<div id="cy"></div>

<script>
    fetch('/spring-neptune-demo/graph/data')
        .then(response => response.json())
        .then(data => {
            console.log('Fetched Data:', data);

            // Extract nodes
            const nodes = Object.keys(data.nodes).map(nodeId => ({
                data: {
                    id: nodeId,
                    name: data.nodes[nodeId].name
                }
            }));

            // Extract edges and handle bidirectional relationships
            const edges = [];
            const processedEdges = new Set(); // To track processed edges

            Object.keys(data.edges).forEach(edgeId => {
                const edge = data.edges[edgeId];
                const source = edge.source.toString();
                const target = edge.target.toString();
                const label = edge.label.toString();
                const reverseLabel = `REVERSED_${label}`;

                // Check if the reverse edge exists and if it's already processed
                if (label === 'FOLLOW' && !processedEdges.has(edgeId)) {
                    const reverseExists = Object.keys(data.edges).some(eId =>
                        data.edges[eId].source === target &&
                        data.edges[eId].target === source &&
                        data.edges[eId].label === reverseLabel
                    );

                    // Add the edge if it's not FOLLOWED_BY and if it's not a duplicate
                    if (!reverseExists) {
                        edges.push({
                            data: {
                                id: `${edge.id}`,
                                source: source,
                                target: target,
                                label: label
                            }
                        });
                        processedEdges.add(edgeId);
                    }
                }
            });

            console.log('Nodes:', nodes);
            console.log('Edges:', edges);

            // Initialize Cytoscape
            const cy = cytoscape({
                container: document.getElementById('cy'),
                elements: {
                    nodes: nodes,
                    edges: edges
                },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#1f77b4',
                            'label': 'data(name)'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'curve-style': 'bezier',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-color': '#ccc',
                            'line-color': '#999',
                            'width': 2,
                            'label': 'data(label)',
                            'text-background-color': '#fff',
                            'text-background-opacity': 1,
                            'text-background-padding': '3px'
                        }
                    }
                ],
                layout: {
                    name: 'grid',
                    rows: 1
                }
            });

            // Optional: Fit the graph to the viewport
            cy.fit();
        })
        .catch(error => console.error('Error fetching data:', error));
</script>
</body>
</html>
